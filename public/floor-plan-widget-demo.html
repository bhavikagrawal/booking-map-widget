<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Studio Floor Plan Widget Demo</title>
    <style>
      /* Minimal styling for clarity */
      body {
        font-family: system-ui, sans-serif;
        padding: 2rem;
        line-height: 1.4;
      }
      h1 {
        margin: 0 0 1rem;
      }
      .meta {
        color: #555;
        font-size: 0.8rem;
        margin-bottom: 0.75rem;
      }
      .tabs {
        display: flex;
        gap: 0.5rem;
        margin: 1rem 0 1.25rem;
      }
      .tab {
        padding: 0.5rem 1rem;
        border: 1px solid #ccc;
        background: #fafafa;
        cursor: pointer;
        border-radius: 4px;
        font-size: 0.85rem;
      }
      .tab.active {
        background: #e5e7eb;
        font-weight: 600;
      }
      .panel {
        display: none;
      }
      .panel.active {
        display: block;
      }
      .widget-shell {
        width: 800px;
        height: 600px;
        border: 1px solid #999;
        background: #f5f5f5;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
      }
      #studio-floorplan-organizer.widget-shell {
        border-style: dashed;
      }
      .legend {
        display: flex;
        gap: 1rem;
        margin: 1rem 0;
        font-size: 0.75rem;
        flex-wrap: wrap;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }
      .dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 2px solid #222;
        box-sizing: border-box;
      }
      .dot.green {
        background: #16a34a;
      }
      .dot.red {
        background: #dc2626;
      }
    </style>
  </head>
  <body>
    <h1>Studio Floor Plan Widget</h1>
    <p class="meta">
      Demo of three modes. Colors: Green = Available, Red = Purchased.
    </p>

    <div class="tabs">
      <button class="tab active" data-tab="customer">Customer</button>
      <button class="tab" data-tab="visitor">Visitor</button>
      <button class="tab" data-tab="organizer">Organizer</button>
    </div>

    <div class="legend" aria-hidden="true">
      <div class="legend-item"><span class="dot green"></span>Available</div>
      <div class="legend-item"><span class="dot red"></span>Purchased</div>
    </div>

    <div id="panel-customer" class="panel active">
      <div id="studio-floorplan-customer" class="widget-shell"></div>
    </div>
    <div id="panel-visitor" class="panel">
      <div id="studio-floorplan-visitor" class="widget-shell"></div>
    </div>
    <div id="panel-organizer" class="panel">
      <div id="studio-floorplan-organizer" class="widget-shell"></div>
    </div>

    <script src="./widget/studio-floorplan-widget.js"></script>
    <script>
      // Clean demo script: shared stalls state, organizer updates propagate to customer & visitor.
      (() => {
        const $ = (s, r = document) => r.querySelector(s);
        const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
        const IDS = {
          customer: "studio-floorplan-customer",
          visitor: "studio-floorplan-visitor",
          organizer: "studio-floorplan-organizer",
        };
        const baseStalls = [
          {
            id: "s-1",
            number: "A1",
            name: "Coffee Corner",
            category: "Food",
            segment: "Basic",
            x: 15,
            y: 25,
          },
          {
            id: "s-2",
            number: "B2",
            name: "Gadget Grove",
            category: "Electronics",
            segment: "Premium",
            x: 40,
            y: 55,
            purchased: true,
          },
          {
            id: "s-3",
            number: "C3",
            name: "Art Alley",
            category: "Art",
            segment: "Combo",
            x: 70,
            y: 30,
          },
          {
            id: "s-4",
            number: "D4",
            name: "Jewels Hub",
            category: "Jewelry",
            segment: "Luxury",
            x: 55,
            y: 75,
          },
        ];
        let stalls = baseStalls.slice();

        function syncOthers() {
          StudioFloorPlan.update(IDS.customer, stalls);
          StudioFloorPlan.update(IDS.visitor, stalls);
        }

        function handleSelectionChange(stall) {
          console.log(
            "[Selection]",
            stall ? stall.id + " " + stall.number : null
          );
          document.dispatchEvent(
            new CustomEvent("studio:stall-select", { detail: { stall } })
          );
        }
        function handleFloorPlanUpdate(data) {
          stalls = data.stalls; // authoritative list after organizer edit/delete
          syncOthers();
        }

        const common = {
          clientId: "demo-client",
          dimensions: { width: 800, height: 600 },
          floorPlanData: {
            floorPlanUrl: "https://placehold.co/600x400",
            stalls,
          },
          handleSelectionChange,
        };

        // Init all three modes
        function initAll() {
          StudioFloorPlan.init({
            ...common,
            containerId: IDS.customer,
            viewType: "customer",
          });
          StudioFloorPlan.init({
            ...common,
            containerId: IDS.visitor,
            viewType: "visitor",
          });
          StudioFloorPlan.init({
            ...common,
            containerId: IDS.organizer,
            viewType: "organizer",
            handleFloorPlanUpdate,
            onStallSave: (stall, info) =>
              console.log("[Save]", stall.id, info.isNew ? "(new)" : ""),
            onStallDelete: (id, remaining) =>
              console.log("[Delete]", id, "remaining", remaining.length)
          });
        }

        // Tabs
        function setupTabs() {
          $$(".tab").forEach((btn) =>
            btn.addEventListener("click", () => {
              if (btn.classList.contains("active")) return;
              $$(".tab").forEach((b) => b.classList.remove("active"));
              btn.classList.add("active");
              const target = btn.dataset.tab;
              $$(".panel").forEach((p) => p.classList.remove("active"));
              $("#panel-" + target).classList.add("active");
              // Resize after showing hidden canvas to correct layout
              setTimeout(() => window.dispatchEvent(new Event("resize")), 20);
            })
          );
        }

        document.addEventListener("DOMContentLoaded", () => {
          if (!window.StudioFloorPlan) {
            console.error("StudioFloorPlan global not found");
            return;
          }
          initAll();
          setupTabs();
          // Initial resize to ensure proper scaling
          setTimeout(() => window.dispatchEvent(new Event("resize")), 30);
        });

        document.addEventListener("studio:stall-select", (e) => {
          const { stall } = e.detail;
          if (stall)
            console.info("[CustomEvent] stall-select", stall.id, stall.number);
        });
      })();
    </script>
  </body>
</html>
